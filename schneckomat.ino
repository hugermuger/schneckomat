#include <Arduino.h>
#include <SPI.h>
#include <U8g2lib.h>
#include "DHT20.h"
#include "RTClib.h"
#include <EEPROM.h>
#include <TriacDimmer.h>

//final

DHT20 DHT;
RTC_DS3231 rtc;
U8G2_SSD1306_128X64_NONAME_2_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE);

int BUTTON_SELECT = 6;
int BUTTON_UP = 5;
int BUTTON_DOWN = 4;
int DIMMER = 9;
int HEAT = 3;

int add_max_temp_day = 0;
int add_min_temp_day = 4;
int add_max_temp_night = 8;
int add_min_temp_night = 12;
int add_light_per_hand = 16;
int add_init = 17;

float temp, humi;
float max_temp_day = 27.0;
float min_temp_day = 24.0;
float max_temp_night = 23.0;
float min_temp_night = 20.0;
float buffer_temp = 0.5;
bool heat_on = 0;
unsigned int morning = 8;
unsigned int evening = 22;

int light_per_hand = 0;

int snail_x = 0;
int snail_x_old = 0;

bool button_clicked = 1;
bool button_up_clicked = 1;
bool button_down_clicked = 1;

bool light_reload = 1;

bool day = 0;

bool reload = 0;

int current_screen = 0;
int item_selected = 0;
int item_sel_previous;
int item_sel_next;

bool light_on = 0;

float oldTime = 0;
unsigned int passedTimeSnail = 61;
unsigned int passedTimeLight = 61;
float passedTimeNoButtonPress = 0;
unsigned int passedTimeLightOn = 0;
float deltaTime = 0;

const unsigned char bitmap_snail [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x80, 0x01, 0x01, 0x00, 0x00, 0xf8, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x01, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x06, 0x02, 0x00, 0xf0, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0xf8, 0xfd, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0xfc, 0x9f, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x18, 0x02, 0x00, 0xbc, 0xe1, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x30, 0x06, 0x00, 0xfe, 0xff, 0xbf, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x70, 0x0e, 0x00, 0xff, 0xf8, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe0, 0x0e, 0x00, 0x37, 0xbc, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc0, 0x1f, 0x80, 0x47, 0x7e, 0xf6, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc0, 0x1f, 0x80, 0x27, 0xbe, 0xff, 0xf7, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x80, 0x7f, 0x80, 0x97, 0xdf, 0xdf, 0xf7, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xc0, 0x09, 0xef, 0xdd, 0xf3, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xc1, 0x15, 0xef, 0x9f, 0xf7, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x43, 0x00, 0xff, 0xbf, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xd0, 0xff, 0x0f, 0x09, 0xbf, 0xbf, 0xf7, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x1f, 0x02, 0x8b, 0xef, 0xf7, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x01, 0xdf, 0xff, 0xb5, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x7f, 0x14, 0xff, 0xb3, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x3f, 0x03, 0x34, 0xfe, 0x9f, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x3f, 0x00, 0xc0, 0xf8, 0x99, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xbf, 0x00, 0xc0, 0x8f, 0xb1, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0xc0, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x0f, 0x00, 0x80, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x8f, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x0b, 0x12, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x4b, 0x20, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x7f, 0x35, 0x00, 0xc2, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xb5, 0xde, 0x01, 0xe0, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x49, 0x36, 0x8b, 0xfe, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const unsigned char bitmap_item_sel_outline [] PROGMEM = {
  0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
  0xFF, 0xFF, 0xFF, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x0C, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0xF8, 0xFF, 0xFF, 0xFF, 
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 
  };

const unsigned char bitmap_scrollbar_background [] PROGMEM = {
  0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 
  0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 
  0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 
  0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 
  0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 
  0x00, 0x40, 0x00, 0x00, };

const unsigned char bitmap_icon_light_on_off [] PROGMEM = {
	0x00, 0x00, 0x08, 0x10, 0xe8, 0x17, 0x30, 0x0c, 0x10, 0x08, 0x10, 0x08, 0x16, 0x68, 0x10, 0x08, 
	0x30, 0x0c, 0x20, 0x04, 0x48, 0x12, 0xc8, 0x13, 0x40, 0x02, 0xc0, 0x03, 0x00, 0x00, 0x00, 0x00
};

const unsigned char bitmap_icon_light_percent [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0xf0, 0x01, 0x08, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 
	0x08, 0x02, 0x10, 0x29, 0x10, 0x39, 0xf0, 0xc7, 0xb0, 0x45, 0xf0, 0xc7, 0x00, 0x38, 0x00, 0x28
};

const unsigned char bitmap_icon_temp_day [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x88, 0x11, 0x10, 0x08, 0xc0, 0x03, 0x20, 0x04, 0x2c, 0x34, 
	0x2c, 0x34, 0x20, 0x04, 0xc0, 0x03, 0x10, 0x08, 0x88, 0x11, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00
};

const unsigned char bitmap_icon_temp_night [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x30, 0x00, 0x28, 0x00, 0x2c, 0x00, 0x24, 0x00, 0x24, 0x00, 
	0x44, 0x00, 0x84, 0x20, 0x08, 0x3f, 0x18, 0x10, 0x30, 0x0c, 0xc0, 0x03, 0x00, 0x00, 0x00, 0x00
};

const unsigned char bitmap_icon_back [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0xc0, 0x00, 0x60, 0x00, 0xe0, 0x0f, 0x60, 0x10, 0xc0, 0x20, 
	0x80, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x10, 0xfc, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

unsigned char* bitmap_icons[5] = {
  bitmap_icon_light_on_off,   
  bitmap_icon_light_percent,  
  bitmap_icon_temp_day,       
  bitmap_icon_temp_night,     
  bitmap_icon_back            
};

const int MAX_ITEM_LENGTH = 14; 
const int NUM_ITEMS = 5;

char menu_items [NUM_ITEMS] [MAX_ITEM_LENGTH] = {  
  { "Light On/Off" },
  { "Light %" },
  { "Temp. Day" },
  { "Temp. Night" },
  { "Back" }
};


void setup() {
  TriacDimmer::begin();
  Wire.begin(); 
  DHT.begin();
  u8g2.begin();
  rtc.begin();

  if (EEPROM.read(add_init) == 'T'){
    EEPROM.get(add_max_temp_day, max_temp_day);
    EEPROM.get(add_min_temp_day, min_temp_day);
    EEPROM.get(add_max_temp_night, max_temp_night);
    EEPROM.get(add_min_temp_night, min_temp_night);
    light_per_hand = EEPROM.read(add_light_per_hand);
  } else {
    EEPROM.put(add_max_temp_day, max_temp_day);
    EEPROM.put(add_min_temp_day, min_temp_day);
    EEPROM.put(add_max_temp_night, max_temp_night);
    EEPROM.put(add_min_temp_night, min_temp_night);
    EEPROM.write(add_light_per_hand, light_per_hand);
    EEPROM.write(add_init, 'T');
  }
}

void loop() {
  DateTime now = rtc.now();
  adjustForDST(now);
  deltaTime = CalculateDeltaTime();
  if (current_screen != 0){
    passedTimeNoButtonPress += deltaTime;
  }

  SetTempAndHumi();

  InputControl();

  HeatandLight(now);

  if (current_screen == 0) { 
    SnailMovement(now);
    if (snail_x_old != snail_x) {
      char humi_string[10];
      char humi_float_string[5];
      dtostrf(humi, 2, 0, humi_float_string);
      snprintf(humi_string,  sizeof(humi_string), "%s%%", humi_float_string);

      char time_string[10];
      snprintf(time_string, sizeof(time_string), "%02d:%02dh", now.hour(), now.minute());

      char temp_string[15];
      char temp_float_string[10];
      char c = 'c';
      if (heat_on) {
      c = 'C';
      }
      dtostrf(temp, 3, 1, temp_float_string);
      snprintf(temp_string,  sizeof(temp_string), "%s\xB0%c", temp_float_string, c);

      u8g2.firstPage();
      do {
        Draw_Main_Screen(humi_string, time_string, temp_string);
      } while ( u8g2.nextPage() );
      snail_x_old = snail_x;
    }
  }
  else if (reload) {
    char p_string[10];
    char setting_string[20];
    char tempStr[10];
    char c = 'C';
    if (current_screen >= 2 && current_screen <= 6) {
      if (current_screen == 2){
        strncpy(setting_string, "Light Percent", sizeof(setting_string));
      } else if (current_screen == 3) {
        dtostrf(max_temp_day, 5, 1, tempStr);
        strncpy(setting_string, "Max. Day", sizeof(setting_string));
      } else if (current_screen == 4) {
        dtostrf(min_temp_day, 5, 1, tempStr);
        strncpy(setting_string, "Min. Day", sizeof(setting_string));
      } else if (current_screen == 5) {
        dtostrf(max_temp_night, 5, 1, tempStr);
        strncpy(setting_string, "Max. Night", sizeof(setting_string));
      } else if (current_screen == 6) {
        dtostrf(min_temp_night, 5, 1, tempStr);
        strncpy(setting_string, "Min. Night", sizeof(setting_string));
      }

      if (current_screen == 2){
        snprintf(p_string,  sizeof(p_string), "%d%%", light_per_hand);
      } else {
        snprintf(p_string,  sizeof(p_string), "%s\xB0%c", tempStr, c);
      }
    }
    u8g2.firstPage();
    do {
      if (current_screen == 1) {
        Draw_Menu();
      } else if (current_screen >= 2 && current_screen <= 6) {
        Draw_Setting(setting_string, p_string);
      }
    } while ( u8g2.nextPage() );
    reload = 0;
  }
}

void HeatandLight(DateTime& dt){
  unsigned int currentMinutes = (dt.hour() * 60) + dt.minute();
  unsigned int startMin = morning * 60;
  unsigned int endMin = evening * 60;

  if (dt.hour() > morning && dt.hour() < evening){
    if (day == 0) {
      day = 1;
    }
    if (temp < (min_temp_day + buffer_temp) && heat_on == 0) {
      digitalWrite(HEAT, HIGH);
      heat_on = 1;
    } else if (((temp > (max_temp_day - buffer_temp)) && heat_on == 1)) {
      digitalWrite(HEAT, LOW);
      heat_on = 0;
    }
  } else {
    if (day == 1) {
      day = 0;
      if (light_on == 1) {
        light_on = 0;
        light_reload = 1;
      }
    }
    if (temp < (min_temp_night + buffer_temp) && heat_on == 0) {
      digitalWrite(HEAT, HIGH);
      heat_on = 1;
    } else if (((temp > (max_temp_night - buffer_temp)) && heat_on == 1)) {
      digitalWrite(HEAT, LOW);
      heat_on = 0;
    }
  }

  if (passedTimeLight != dt.minute()) {
    if (day == 1) {
     light_reload = 1;
    }
    passedTimeLight = dt.minute();
    if (light_on == 1) {
      passedTimeLightOn ++;
      if (passedTimeLightOn >= 10){
        light_on = 0;
        passedTimeLightOn = 0;
      }
    }
  }

  if (light_reload) {
    float foutVal = 0.24 + (light_per_hand * 0.0026);
    if (light_on == 0) {
      if (day == 0) {
        foutVal = 0.0;
      } else {
        if (dt.hour() <= (evening - morning)) {
          foutVal = 0.24 + ((100.0 / ((endMin-startMin)/2.0) * (currentMinutes-startMin)) * 0.0026);
        } else {
          foutVal = 0.24 + ((100.0 - (100 / ((endMin-startMin)/2.0) * (currentMinutes-(endMin-startMin)))) * 0.0026);
        }
      }
    }
    TriacDimmer::setBrightness(DIMMER, foutVal); 
    light_reload = 0;
  }
}

void SetTempAndHumi () {
  int status = DHT.read();
  temp = DHT.getTemperature();
  humi = DHT.getHumidity();
}

void SnailMovement (DateTime& dt) {
  if (passedTimeSnail != dt.second()) {
    if (snail_x > -91) {
      snail_x --;
    } else {
      snail_x = 96;
    }
    passedTimeSnail = dt.second();    
  }
}

void InputControl () {
  int light_change = 5;
  float temp_change = 0.5;
  if ((digitalRead(BUTTON_SELECT) == LOW) && (button_clicked == 0)) { 
    button_clicked = 1;
    reload = 1;
    passedTimeNoButtonPress = 0;
    if (current_screen == 0) {
      current_screen = 1;
      item_selected = 0;
    } else if (current_screen == 1) {
      if (item_selected == 0){
        if (light_on == 0){
          light_on = 1;
          light_reload = 1;
        } else {
          light_on = 0;
          light_reload = 1;
        }
      } else if (item_selected == 1){
        current_screen = 2;
      } else if (item_selected == 2){
        current_screen = 3;
      } else if (item_selected == 3){
        current_screen = 5;
      } else if (item_selected == 4){
        current_screen = 0;
      }
    } else if (current_screen == 2) {
      EEPROM.write(add_light_per_hand, light_per_hand);
      current_screen = 1;
      item_selected = 1;
    } else if (current_screen == 3) {
      EEPROM.put(add_max_temp_day, max_temp_day);
      current_screen = 4;
    } else if (current_screen == 4) {
      EEPROM.put(add_min_temp_day, min_temp_day);
      current_screen = 1;
      item_selected = 2;
    } else if (current_screen == 5) {
      EEPROM.put(add_max_temp_night, max_temp_night);
      current_screen = 6;
    } else if (current_screen == 6) {
      EEPROM.put(add_min_temp_night, min_temp_night);
      current_screen = 1;
      item_selected = 3;
    }
  }
  if ((digitalRead(BUTTON_SELECT) == HIGH) && (button_clicked == 1)) { 
    button_clicked = 0;
  }

  if (passedTimeNoButtonPress >= 60000.0){
    current_screen = 0;
  }

  if ((digitalRead(BUTTON_UP) == LOW) && (button_up_clicked == 0)) {
    button_up_clicked = 1;
    reload = 1;
    passedTimeNoButtonPress = 0;
    if (current_screen == 1) {
      item_selected = item_selected - 1; 
      if (item_selected < 0) { 
        item_selected = NUM_ITEMS - 1;
      }
    } else if (current_screen == 2){
      light_per_hand += light_change;
      if (light_per_hand > 100) {
        light_per_hand = 100;
      }
      light_reload = 1;
    } else if (current_screen == 3){
      max_temp_day += temp_change;
    } else if (current_screen == 4){
      min_temp_day += temp_change;
      if (max_temp_day <= min_temp_day) {
        min_temp_day = max_temp_day - temp_change;
      }
    } else if (current_screen == 5){
      max_temp_night += temp_change;
    } else if (current_screen == 6){
      min_temp_night += temp_change;
      if (max_temp_night <= min_temp_night) {
        min_temp_night = max_temp_night - temp_change;
      }
    }
  }

  if ((digitalRead(BUTTON_UP) == HIGH) && (button_up_clicked == 1)) { 
        button_up_clicked = 0;
  }

  if ((digitalRead(BUTTON_DOWN) == LOW) && (button_down_clicked == 0)) {
    button_down_clicked = 1;
    reload = 1;
    passedTimeNoButtonPress = 0;
    if (current_screen == 1) {
      item_selected = item_selected + 1;
      if (item_selected > (NUM_ITEMS - 1)) {
        item_selected = 0;
      } 
    } else if (current_screen == 2){
      light_per_hand -= light_change;
      if (light_per_hand < 0) {
        light_per_hand = 0;
      }
      light_reload = 1;
    } else if (current_screen == 3){
      max_temp_day -= temp_change;
      if (max_temp_day <= min_temp_day) {
        max_temp_day = min_temp_day + temp_change;
      }
    } else if (current_screen == 4){
      min_temp_day -= temp_change;
    } else if (current_screen == 5){
      max_temp_night -= temp_change;
      if (max_temp_night <= min_temp_night) {
        max_temp_night = min_temp_night + temp_change;
      }
    } else if (current_screen == 6){
      min_temp_night -= temp_change;
    }
  }

  if ((digitalRead(BUTTON_DOWN) == HIGH) && (button_down_clicked == 1)) { 
        button_down_clicked = 0;
  }
}


// U8G2 LOGIC

void Draw_Main_Screen (char* h_str, char* t_str, char* temp_str) {
  u8g2.setFont(u8g2_font_6x13_tf);

  u8g2.drawStr(0,9,h_str);
  u8g2.drawStr(40,9,t_str);
  u8g2.drawStr(93,9,temp_str);
  u8g2.drawHLine(0, 11, 128);

  u8g2.drawXBMP(snail_x, 20, 128, 52, bitmap_snail);
}

void Draw_Menu() {
  if (item_selected == 0) {
    u8g2.drawXBMP(0, 0, 128, 21, bitmap_item_sel_outline);

    u8g2.setFont(u8g_font_7x14);
    u8g2.drawStr(25, 15, menu_items[item_selected]);
    u8g2.drawXBMP( 4, 2, 16, 16, bitmap_icons[item_selected]);        

    u8g2.setFont(u8g_font_7x14);
    u8g2.drawStr(25, 15+20+2, menu_items[item_selected + 1]);  
    u8g2.drawXBMP( 4, 24, 16, 16, bitmap_icons[item_selected + 1]);     
    u8g2.drawStr(25, 15+20+20+2+2, menu_items[item_selected + 2]);  
    u8g2.drawXBMP( 4, 46, 16, 16, bitmap_icons[item_selected + 2]);  
  } else if (item_selected == (NUM_ITEMS - 1)){
    u8g2.drawXBMP(0, 43, 128, 21, bitmap_item_sel_outline);

    u8g2.setFont(u8g_font_7x14);
    u8g2.drawStr(25, 15, menu_items[item_selected-2]);
    u8g2.drawXBMP( 4, 2, 16, 16, bitmap_icons[item_selected-2]);          
    u8g2.drawStr(25, 15+20+2, menu_items[item_selected-1]);  
    u8g2.drawXBMP( 4, 24, 16, 16, bitmap_icons[item_selected-1]);    

    u8g2.setFont(u8g_font_7x14);    
    u8g2.drawStr(25, 15+20+20+2+2, menu_items[item_selected]);  
    u8g2.drawXBMP( 4, 46, 16, 16, bitmap_icons[item_selected]);  
  } else {
    item_sel_previous = item_selected - 1;

    if (item_sel_previous < 0) {item_sel_previous = (NUM_ITEMS - 1);} 
    item_sel_next = item_selected + 1;  

    if (item_sel_next > (NUM_ITEMS - 1)) {item_sel_next = 0;}

    u8g2.drawXBMP(0, 22, 128, 21, bitmap_item_sel_outline);

    u8g2.setFont(u8g_font_7x14);
    u8g2.drawStr(25, 15, menu_items[item_sel_previous]);
    u8g2.drawXBMP( 4, 2, 16, 16, bitmap_icons[item_sel_previous]);          

    u8g2.setFont(u8g_font_7x14);    
    u8g2.drawStr(25, 15+20+2, menu_items[item_selected]);  
    u8g2.drawXBMP( 4, 24, 16, 16, bitmap_icons[item_selected]);    

    u8g2.setFont(u8g_font_7x14);    
    u8g2.drawStr(25, 15+20+20+2+2, menu_items[item_sel_next]);  
    u8g2.drawXBMP( 4, 46, 16, 16, bitmap_icons[item_sel_next]);
  }

  u8g2.drawXBMP(128-8, 0, 8, 64, bitmap_scrollbar_background);

  u8g2.drawBox(125, 64/(1 + (NUM_ITEMS - 1)) * (item_selected), 3, 64/(1 + (NUM_ITEMS - 1)));
}

void Draw_Setting(char* s_str, char* p_str){
  u8g2.setFont(u8g2_font_6x13_tf);
  u8g2.drawStr(0,9,s_str);
  u8g2.drawHLine(0, 11, 128);
  u8g2.setFont(u8g_font_7x14);
  u8g2.drawStr(50,45,p_str);
}


// TIME CALCULATION

float CalculateDeltaTime(){
  float currentTime = millis();
  float deltaTime = currentTime - oldTime;
  oldTime = currentTime;
  return deltaTime;
}

boolean summertime(const DateTime& dt)
{ 
  if (dt.month()<3 || dt.month()>10) return false; 
  if (dt.month()>3 && dt.month()<10) return true; 
  if (dt.month()==3 && (dt.hour() + 24 * dt.day())>=(1 + 24*(31 - (5 * dt.year() /4 + 4) % 7)) || dt.month()==10 && (dt.hour() + 24 * dt.day())<(1 + 24*(31 - (5 * dt.year() /4 + 1) % 7))) 
    return true; 
  else 
    return false;
}

void adjustForDST(DateTime& dt) {
  if (summertime(dt)) 
  {
    dt = dt + TimeSpan(0, 1, 0, 0);
  }
}